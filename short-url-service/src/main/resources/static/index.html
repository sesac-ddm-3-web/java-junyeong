<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Short URL API Tester</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for output area */
        #output-area::-webkit-scrollbar {
            width: 8px;
        }
        #output-area::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        #output-area::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center font-sans p-4">

<div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-8 space-y-8">
    <h1 class="text-4xl font-bold text-center text-indigo-700 border-b-2 pb-4">단축 URL 서비스 테스트</h1>

    <!-- API Test Sections -->
    <div class="grid md:grid-cols-2 gap-8">

        <!-- 1. 단축 URL 생성 (POST /shorten-url) -->
        <div class="bg-indigo-50 p-6 rounded-lg shadow-md border border-indigo-200">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-800">1. URL 생성</h2>
            <div class="space-y-4">
                <label for="originalUrl" class="block text-sm font-medium text-gray-700">원본 URL (Original URL)</label>
                <input type="url" id="originalUrl" placeholder="예: https://www.google.com" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">

                <label for="shortenUrlKey" class="block text-sm font-medium text-gray-700">사용자 지정 키 (선택 사항)</label>
                <input type="text" id="customKey" placeholder="원하는 단축 키 (선택)"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">

                <button id="createBtn" onclick="createShortUrl()"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105">
                    단축 URL 생성 (POST)
                </button>
            </div>
        </div>

        <!-- 2. 단축 URL 정보 조회 (GET /shorten-url/{key}) -->
        <div class="bg-green-50 p-6 rounded-lg shadow-md border border-green-200">
            <h2 class="text-2xl font-semibold mb-4 text-green-800">2. URL 정보 조회</h2>
            <div class="space-y-4">
                <label for="queryKey" class="block text-sm font-medium text-gray-700">조회할 단축 키 (Shorten Key)</label>
                <input type="text" id="queryKey" placeholder="생성된 단축 키 입력" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                <button id="infoBtn" onclick="getShortUrlInfo()"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105">
                    정보 조회 (GET)
                </button>
                <button id="redirectBtn" onclick="testRedirect()"
                        class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105">
                    리다이렉트 테스트 (새 창)
                </button>
            </div>
        </div>
    </div>

    <!-- 결과 출력 영역 -->
    <div class="pt-6 border-t-2 mt-8">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">API 응답 결과</h2>
        <pre id="output-area" class="bg-gray-800 text-green-400 p-4 rounded-lg shadow-inner overflow-auto h-64 text-sm whitespace-pre-wrap"></pre>
    </div>

    <!-- 메시지 박스 -->
    <div id="message-box" class="fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white hidden z-50 transition duration-300 transform translate-y-0"></div>

</div>

<script>
    const BASE_URL = 'http://localhost:8080';

    // 유틸리티 함수: 메시지 박스 표시
    function showMessage(message, type = 'success') {
        const box = document.getElementById('message-box');
        box.textContent = message;

        let bgColor = '';
        if (type === 'success') {
            bgColor = 'bg-green-500';
        } else if (type === 'error') {
            bgColor = 'bg-red-500';
        } else {
            bgColor = 'bg-blue-500';
        }

        box.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition duration-300 ${bgColor}`;
        box.style.display = 'block';

        setTimeout(() => {
            box.style.display = 'none';
        }, 3000);
    }

    // 유틸리티 함수: 결과를 JSON 형식으로 출력
    function displayOutput(data, status) {
        const outputArea = document.getElementById('output-area');
        let output = `--- Status: ${status} ---\n`;

        if (data && typeof data === 'object') {
            output += JSON.stringify(data, null, 2);
        } else if (data) {
            output += data;
        } else {
            output += 'No content returned.';
        }

        outputArea.textContent = output;
    }

    // 1. 단축 URL 생성 (POST /shorten-url)
    async function createShortUrl() {
        const originalUrl = document.getElementById('originalUrl').value;
        const customKey = document.getElementById('customKey').value;

        if (!originalUrl) {
            showMessage('원본 URL을 입력해야 합니다.', 'error');
            return;
        }

        const payload = {
            originalUrl: originalUrl
        };

        if (customKey) {
            payload.shortenUrlKey = customKey;
        }

        try {
            const response = await fetch(`${BASE_URL}/shorten-url`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            displayOutput(data, response.status);

            if (response.ok) {
                showMessage(`단축 URL 생성 성공! 키: ${data.shortenUrlKey}`, 'success');
                // 생성된 키를 정보 조회 칸에 자동 입력
                document.getElementById('queryKey').value = data.shortenUrlKey;
            } else {
                showMessage(`URL 생성 실패: ${data.message || response.statusText}`, 'error');
            }

        } catch (error) {
            console.error('API Error:', error);
            displayOutput(`Request failed: ${error.message}`, 'Network Error');
            showMessage('서버 연결 또는 요청 실패', 'error');
        }
    }

    // 2. 단축 URL 정보 조회 (GET /shorten-url/{key})
    async function getShortUrlInfo() {
        const key = document.getElementById('queryKey').value;

        if (!key) {
            showMessage('조회할 단축 키를 입력해야 합니다.', 'error');
            return;
        }

        try {
            const response = await fetch(`${BASE_URL}/shorten-url/${key}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json' // 정보 조회 엔드포인트를 명시적으로 호출하기 위해 Accept 헤더 사용
                }
            });

            if (response.status === 404) {
                displayOutput(null, 404);
                showMessage(`단축 키 '${key}'를 찾을 수 없습니다. (404)`, 'error');
                return;
            }

            const data = await response.json();
            displayOutput(data, response.status);

            if (response.ok) {
                showMessage(`정보 조회 성공: ${key}`, 'success');
            } else {
                showMessage(`정보 조회 실패: ${data.message || response.statusText}`, 'error');
            }

        } catch (error) {
            console.error('API Error:', error);
            displayOutput(`Request failed: ${error.message}`, 'Network Error');
            showMessage('서버 연결 또는 요청 실패', 'error');
        }
    }

    // 3. 리다이렉트 테스트
    function testRedirect() {
        const key = document.getElementById('queryKey').value;

        if (!key) {
            showMessage('리다이렉트 테스트할 단축 키를 입력해야 합니다.', 'error');
            return;
        }

        // 사용자의 ShortenUrlRestController.java에서 리다이렉트 매핑이
        // GET /shorten-url/{key}에 잡혀있는 것으로 보이지만,
        // 실제 리다이렉션은 보통 루트 경로 /{key}를 사용합니다.
        // 여기서는 사용자 컨트롤러에 정의된 경로를 사용합니다.
        const redirectUrl = `${BASE_URL}/redirect/${key}`;

        window.open(redirectUrl, '_blank');
        showMessage(`새 창에서 '${redirectUrl}'로 이동합니다.`, 'info');
    }

</script>
</body>
</html>