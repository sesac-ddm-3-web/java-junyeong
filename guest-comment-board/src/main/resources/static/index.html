<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
</head>
<body>
    <form action="/comments" method="post" onsubmit="return addComment()">
        <label for="nickname">닉네임: </label>
        <input id="nickname" type="text" name="nickname">
        <label for="content">댓글 내용: </label>
        <input id="content" type="text" name="content">
        <button type="submit">제출하기</button>
        <button type="button" onclick="displayCommentList()">댓글 내역 조회</button>
    </form>
    <ol id="comment-list">
        <!--  댓글 리스트 렌더링   -->
    </ol>
    <script>
        function addComment(){
            const nickname = document.querySelector('input[name=nickname]').value;
            const content = document.querySelector('input[name=content]').value;

            const requestObj = { nickname: nickname, content: content };
            const requestJSON = JSON.stringify(requestObj);

            function onReadyStateChange(event){
                const currentAjaxRequest = event.currentTarget;

                if(currentAjaxRequest.readyState === XMLHttpRequest.DONE){
                    if(currentAjaxRequest.status === 200){
                        alert("댓글이 등록되었습니다.");
                    } else{
                        console.error("request failed");
                    }
                }
            }

            const ajaxRequest = new XMLHttpRequest();

            ajaxRequest.onreadystatechange = onReadyStateChange;
            ajaxRequest.open("POST", "/comments");
            ajaxRequest.setRequestHeader("Content-Type", "application/json");
            ajaxRequest.send(requestJSON);

            return false;
        }

        function displayCommentList(){
            function onReadyStateChange(event){
                console.log(event);
                const currentAjaxRequest = event.currentTarget;

                if(currentAjaxRequest.readyState === XMLHttpRequest.DONE){
                    if(currentAjaxRequest.status === 200){
                        const commentListDOM = document.querySelector("#comment-list");
                        commentListDOM.innerHTML = '';

                        const comments = JSON.parse(currentAjaxRequest.responseText);
                        comments.forEach(comment => {
                            const liNode = document.createElement('li');
                            const textContent = `닉네임: ${comment.nickname}
                            댓글 내용: ${comment.content}`;
                            const textNode = document.createTextNode(textContent);

                            liNode.appendChild(textNode);
                            commentListDOM.appendChild(liNode);
                        })
                    }
                }
            }

            const ajaxRuest = new XMLHttpRequest();

            ajaxRuest.onreadystatechange = onReadyStateChange;
            ajaxRuest.open("GET", "/comments");
            ajaxRuest.send();
        }
    </script>
</body>
</html>